<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flashcard Practice</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            min-height: 100vh;
            background: linear-gradient(135deg, #f0f8ff 0%, #e0e7ff 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }

        .container {
            background: white;
            border-radius: 1rem;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.1);
            padding: 2rem;
            width: 100%;
            max-width: 28rem;
        }

        .header {
            text-align: center;
            margin-bottom: 1.5rem;
        }

        .title {
            font-size: 1.5rem;
            font-weight: bold;
            color: #1f2937;
            margin-bottom: 0.5rem;
        }

        .stats {
            display: flex;
            justify-content: center;
            gap: 1.5rem;
            font-size: 0.875rem;
        }

        .stat-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-weight: 500;
        }

        .stat-correct {
            background-color: #dbeafe;
            color: #1e40af;
        }

        .stat-mastered {
            background-color: #dcfce7;
            color: #166534;
        }

        .timer {
            text-align: center;
            margin-bottom: 1rem;
        }

        .timer-display {
            font-size: 2rem;
            font-family: 'Courier New', monospace;
            font-weight: bold;
            color: #2563eb;
        }

        .timer-urgent {
            color: #dc2626;
        }

        .card {
            background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
            border-radius: 0.75rem;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            color: white;
            text-align: center;
        }

        .card-front {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .card-subtitle {
            font-size: 0.875rem;
            opacity: 0.8;
        }

        .waiting-card {
            background: #f3f4f6;
            color: #6b7280;
        }

        .input-container {
            margin-bottom: 1rem;
        }

        .answer-input {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #d1d5db;
            border-radius: 0.5rem;
            font-size: 1.125rem;
            outline: none;
            transition: border-color 0.2s;
        }

        .answer-input:focus {
            border-color: #3b82f6;
        }

        .input-hint {
            text-align: center;
            margin-top: 0.5rem;
            font-size: 0.875rem;
            color: #6b7280;
        }

        .result {
            margin-bottom: 1rem;
        }

        .result-box {
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
        }

        .result-correct {
            background-color: #dcfce7;
            color: #166534;
        }

        .result-incorrect {
            background-color: #fef2f2;
            color: #dc2626;
        }

        .result-title {
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .result-details {
            font-size: 0.875rem;
            color: #374151;
        }

        .result-answer {
            font-family: 'Courier New', monospace;
            font-weight: 600;
        }

        .progress-dots {
            display: flex;
            justify-content: center;
            gap: 0.25rem;
            margin-bottom: 1rem;
        }

        .progress-dot {
            width: 2rem;
            height: 0.5rem;
            border-radius: 9999px;
            background-color: #d1d5db;
            transition: background-color 0.2s;
        }

        .progress-dot.active {
            background-color: #3b82f6;
        }

        .waiting-message {
            text-align: center;
            color: #6b7280;
            margin-bottom: 1rem;
        }

        .waiting-subtitle {
            font-size: 0.875rem;
            color: #9ca3af;
        }

        .completion-container {
            text-align: center;
        }

        .completion-title {
            font-size: 1.875rem;
            font-weight: bold;
            color: #1f2937;
            margin-bottom: 1rem;
        }

        .completion-message {
            font-size: 1.125rem;
            color: #6b7280;
        }

        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div id="game-container">
            <div class="header">
                <h1 class="title">Flashcard Practice</h1>
                <div class="stats">
                    <div class="stat-badge stat-correct">
                        <span id="percent-correct">0</span>% Correct
                    </div>
                    <div class="stat-badge stat-mastered">
                        <span id="cards-mastered">0</span> Mastered
                    </div>
                </div>
            </div>

        <!-- Timer -->
        <div id="timer" class="timer hidden">
            <div id="timer-display" class="timer-display">0:00</div>
        </div>

        <!-- Card Display -->
        <div id="card-display" class="card hidden">
            <div id="card-front" class="card-front"></div>
            <div class="card-subtitle">What's the translation?</div>
        </div>

        <!-- Waiting State -->
        <div id="waiting-state" class="waiting-card card">
            <div class="card-front">Ready to start?</div>
            <div class="card-subtitle">Press Enter to begin</div>
        </div>

        <!-- Input Section -->
        <div id="input-section" class="input-container hidden">
            <input
                type="text"
                id="answer-input"
                class="answer-input"
                placeholder="Type your answer..."
            >
            <div class="input-hint">Press Enter to submit</div>
        </div>

        <!-- Result Section -->
        <div id="result-section" class="result hidden">
            <div id="result-box" class="result-box">
                <div id="result-title" class="result-title"></div>
                <div id="result-details" class="result-details"></div>
            </div>
            <div class="input-hint">Press Enter to continue</div>
        </div>

        <!-- Progress Dots -->
        <div id="progress-dots" class="progress-dots hidden"></div>

        <!-- Waiting Message -->
        <div id="waiting-message" class="waiting-message">
            <p>Press Enter to start your first card</p>
            <div class="waiting-subtitle">Get ready to practice!</div>
        </div>

        <!-- Completion Screen -->
        <div id="completion-screen" class="completion-container hidden">
            <h1 class="completion-title">ðŸŽ‰ Congratulations!</h1>
            <p class="completion-message">You've completed all the flashcards!</p>
        </div>
    </div>

    <script>
        class FlashcardApp {
            constructor() {
                this.defaultCards = [
                    { front: "Hello", back: "Hola" },
                    { front: "Goodbye", back: "AdiÃ³s" },
                    { front: "Thank you", back: "Gracias" },
                    { front: "Please", back: "Por favor" },
                    { front: "Yes", back: "SÃ­" },
                    { front: "No", back: "No" },
                    { front: "Water", back: "Agua" },
                    { front: "Food", back: "Comida" },
                    { front: "House", back: "Casa" },
                    { front: "Car", back: "Coche" },
                    { front: "Dog", back: "Perro" },
                    { front: "Cat", back: "Gato" },
                    { front: "Book", back: "Libro" },
                    { front: "School", back: "Escuela" },
                    { front: "Friend", back: "Amigo" }
                ];

                this.allCards = [];
                this.activeCards = [];
                this.currentCardIndex = 0;
                this.userInput = '';
                this.gameState = 'loading';
                this.timeLeft = 0;
                this.isTimerRunning = false;
                this.cardProgress = {};
                this.usedCardIds = new Set();
                this.showResult = false;
                this.lastAnswer = { correct: false, userAnswer: '', correctAnswer: '' };
                this.totalAttempts = 0;
                this.correctAttempts = 0;
                this.timerInterval = null;
                this.availableChapters = [];
                this.selectedChapters = new Set();

                this.init();
            }

            async init() {
                await this.discoverChapters();
                this.showChapterSelection();
            }

            async discoverChapters() {
                // Try to load flashcards.json
                await this.tryLoadChapter('flashcards.json');
                console.log(`Found ${this.availableChapters.length} chapter files`);
            }

            async tryLoadChapter(filename) {
                try {
                    const response = await fetch(filename);
                    if (response.ok) {
                        const data = await response.json();
                        if (Array.isArray(data) && data.length > 0 && this.isValidCardFormat(data[0])) {
                            this.availableChapters.push({
                                filename: filename,
                                displayName: this.formatChapterName(filename),
                                cardCount: data.length,
                                cards: data
                            });
                        }
                    }
                } catch (error) {
                    // File doesn't exist or isn't valid JSON, continue
                }
            }

            isValidCardFormat(card) {
                return card &&
                       typeof card === 'object' &&
                       typeof card.front === 'string' &&
                       typeof card.back === 'string';
            }

            formatChapterName(filename) {
                // Convert filename to display name
                const name = filename.replace('.json', '');
                return name.charAt(0).toUpperCase() + name.slice(1).replace(/([0-9]+)/g, ' $1');
            }

            showChapterSelection() {
                if (this.availableChapters.length === 0) {
                    // No flashcards.json found, use default cards
                    this.allCards = this.defaultCards;
                    this.startGame();
                    return;
                }

                // flashcards.json found, but since it's just one file, skip selection and load it directly
                this.allCards = [];
                let cardId = 1;

                this.availableChapters[0].cards.forEach(card => {
                    this.allCards.push({
                        id: cardId++,
                        front: card.front,
                        back: card.back,
                        chapter: this.availableChapters[0].displayName
                    });
                });

                console.log(`Loaded ${this.allCards.length} cards from flashcards.json`);
                this.startGame();
            }

            createChapterSelectionUI() {
                const container = document.querySelector('.container');

                const chapterSelectionHTML = `
                    <div id="chapter-selection">
                        <h2 style="text-align: center; margin-bottom: 2rem; color: #1f2937;">Select Chapters to Study</h2>
                        <div id="chapter-list" style="margin-bottom: 2rem;">
                            ${this.availableChapters.map(chapter => `
                                <div class="chapter-item" style="display: flex; align-items: center; justify-content: space-between; padding: 1rem; margin-bottom: 0.5rem; border: 2px solid #e5e7eb; border-radius: 0.5rem; cursor: pointer; transition: all 0.2s;" data-filename="${chapter.filename}">
                                    <div style="display: flex; align-items: center;">
                                        <input type="checkbox" class="chapter-checkbox" style="margin-right: 1rem; transform: scale(1.2);" data-filename="${chapter.filename}">
                                        <div>
                                            <div style="font-weight: 600; color: #1f2937;">${chapter.displayName}</div>
                                            <div style="font-size: 0.875rem; color: #6b7280;">${chapter.cardCount} cards</div>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        <div style="text-align: center;">
                            <button id="start-study" style="background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%); color: white; border: none; padding: 0.75rem 2rem; border-radius: 0.5rem; font-size: 1.125rem; font-weight: 600; cursor: pointer; margin-right: 1rem;" disabled>Start Studying</button>
                            <button id="select-all" style="background: #f3f4f6; color: #374151; border: 1px solid #d1d5db; padding: 0.75rem 1.5rem; border-radius: 0.5rem; font-size: 1rem; cursor: pointer;">Select All</button>
                        </div>
                    </div>
                `;

                container.innerHTML = chapterSelectionHTML;
                this.bindChapterSelectionEvents();
            }

            bindChapterSelectionEvents() {
                const checkboxes = document.querySelectorAll('.chapter-checkbox');
                const startButton = document.getElementById('start-study');
                const selectAllButton = document.getElementById('select-all');
                const chapterItems = document.querySelectorAll('.chapter-item');

                // Make entire chapter item clickable
                chapterItems.forEach(item => {
                    item.addEventListener('click', (e) => {
                        if (e.target.type !== 'checkbox') {
                            const checkbox = item.querySelector('.chapter-checkbox');
                            checkbox.checked = !checkbox.checked;
                            this.updateChapterSelection();
                        }
                    });
                });

                checkboxes.forEach(checkbox => {
                    checkbox.addEventListener('change', () => {
                        this.updateChapterSelection();
                    });
                });

                selectAllButton.addEventListener('click', () => {
                    const allChecked = Array.from(checkboxes).every(cb => cb.checked);
                    checkboxes.forEach(checkbox => {
                        checkbox.checked = !allChecked;
                    });
                    this.updateChapterSelection();
                });

                startButton.addEventListener('click', () => {
                    this.loadSelectedChapters();
                });
            }

            updateChapterSelection() {
                const checkboxes = document.querySelectorAll('.chapter-checkbox');
                const startButton = document.getElementById('start-study');
                const selectAllButton = document.getElementById('select-all');
                const chapterItems = document.querySelectorAll('.chapter-item');

                let selectedCount = 0;
                this.selectedChapters.clear();

                checkboxes.forEach((checkbox, index) => {
                    const chapterItem = chapterItems[index];
                    if (checkbox.checked) {
                        selectedCount++;
                        this.selectedChapters.add(checkbox.dataset.filename);
                        chapterItem.style.borderColor = '#3b82f6';
                        chapterItem.style.backgroundColor = '#eff6ff';
                    } else {
                        chapterItem.style.borderColor = '#e5e7eb';
                        chapterItem.style.backgroundColor = 'white';
                    }
                });

                startButton.disabled = selectedCount === 0;
                startButton.style.opacity = selectedCount === 0 ? '0.5' : '1';
                startButton.style.cursor = selectedCount === 0 ? 'not-allowed' : 'pointer';

                const allChecked = selectedCount === checkboxes.length;
                selectAllButton.textContent = allChecked ? 'Deselect All' : 'Select All';
            }

            loadSelectedChapters() {
                this.allCards = [];
                let cardId = 1;

                this.availableChapters.forEach(chapter => {
                    if (this.selectedChapters.has(chapter.filename)) {
                        chapter.cards.forEach(card => {
                            this.allCards.push({
                                id: cardId++,
                                front: card.front,
                                back: card.back,
                                chapter: chapter.displayName
                            });
                        });
                    }
                });

                console.log(`Loaded ${this.allCards.length} cards from ${this.selectedChapters.size} chapters`);
                this.startGame();
            }

            startGame() {
                // Hide chapter selection and show game
                const chapterSelection = document.getElementById('chapter-selection');
                if (chapterSelection) {
                    chapterSelection.style.display = 'none';
                }

                const gameContainer = document.getElementById('game-container');
                if (gameContainer) {
                    gameContainer.style.display = 'block';
                } else {
                    // Create game container if it doesn't exist
                    const container = document.querySelector('.container');
                    container.innerHTML = `<div id="game-container">${container.innerHTML}</div>`;
                }

                this.initializeGame();
                this.bindEvents();
                this.updateDisplay();
            }

            initializeGame() {
                if (this.allCards.length === 0) {
                    console.error('No flashcards available!');
                    return;
                }

                const initialCards = this.allCards.slice(0, Math.min(5, this.allCards.length));
                this.activeCards = initialCards;
                this.usedCardIds = new Set(initialCards.map(card => card.id));

                const initialProgress = {};
                initialCards.forEach(card => {
                    initialProgress[card.id] = 0;
                });
                this.cardProgress = initialProgress;

                // Set to waiting state after loading
                this.gameState = 'waiting';
            }

            bindEvents() {
                const input = document.getElementById('answer-input');
                input.addEventListener('input', (e) => {
                    this.userInput = e.target.value;
                });

                // Handle Enter key globally based on game state
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();

                        if (this.gameState === 'waiting') {
                            this.startAnswering();
                        } else if (this.gameState === 'answering' && !this.showResult) {
                            this.handleSubmitAnswer();
                        } else if (this.gameState === 'reviewing' && this.showResult) {
                            this.handleNextCard();
                        }
                    }
                });
            }

            startAnswering() {
                this.gameState = 'answering';
                this.showResult = false;
                if (this.activeCards.length > 0) {
                    this.startTimer(this.activeCards[this.currentCardIndex].back.length);
                }
                this.updateDisplay();
                setTimeout(() => {
                    const input = document.getElementById('answer-input');
                    input.focus();
                }, 100);
            }

            startTimer(expectedLength) {
                const timerDuration = Math.max(10, 10 + expectedLength);
                this.timeLeft = timerDuration;
                this.isTimerRunning = true;

                this.timerInterval = setInterval(() => {
                    this.timeLeft--;
                    this.updateTimerDisplay();

                    if (this.timeLeft <= 0) {
                        this.handleTimeUp();
                    }
                }, 1000);
            }

            stopTimer() {
                this.isTimerRunning = false;
                if (this.timerInterval) {
                    clearInterval(this.timerInterval);
                }
            }

            handleTimeUp() {
                this.isTimerRunning = false;
                this.handleSubmitAnswer();
            }

            handleSubmitAnswer() {
                if (this.activeCards.length === 0) return;

                const currentCard = this.activeCards[this.currentCardIndex];
                const isCorrect = this.userInput.trim().toLowerCase() === currentCard.back.toLowerCase();

                this.lastAnswer = {
                    correct: isCorrect,
                    userAnswer: this.userInput.trim(),
                    correctAnswer: currentCard.back
                };

                this.totalAttempts++;
                if (isCorrect) {
                    this.correctAttempts++;
                }

                const newProgress = { ...this.cardProgress };
                if (isCorrect) {
                    newProgress[currentCard.id] = (newProgress[currentCard.id] || 0) + 1;
                } else {
                    newProgress[currentCard.id] = 0;
                }
                this.cardProgress = newProgress;

                // Set to reviewing state and show result
                this.showResult = true;
                this.gameState = 'reviewing';
                this.stopTimer();

                // Remove focus from input so global handler takes over
                document.getElementById('answer-input').blur();
                this.updateDisplay();
            }

            handleNextCard() {
                const updatedCards = this.activeCards.filter(card => (this.cardProgress[card.id] || 0) < 5);

                let cardsToAdd = [];
                const availableCards = this.allCards.filter(card => !this.usedCardIds.has(card.id));

                const allCurrentCardsCorrect = this.activeCards.every(card => (this.cardProgress[card.id] || 0) > 0);

                if (updatedCards.length < 5 && availableCards.length > 0) {
                    const cardsNeeded = Math.min(5 - updatedCards.length, availableCards.length);
                    cardsToAdd = availableCards.slice(0, cardsNeeded);
                } else if (allCurrentCardsCorrect && availableCards.length > 0) {
                    cardsToAdd = [availableCards[0]];
                }

                const newUsedCardIds = new Set(this.usedCardIds);
                cardsToAdd.forEach(card => {
                    newUsedCardIds.add(card.id);
                    this.cardProgress[card.id] = 0;
                });
                this.usedCardIds = newUsedCardIds;

                const newActiveCards = [...updatedCards, ...cardsToAdd];
                this.activeCards = newActiveCards;

                if (newActiveCards.length === 0) {
                    this.gameState = 'completed';
                    this.updateDisplay();
                    return;
                }

                let nextIndex = this.currentCardIndex;
                if (nextIndex >= newActiveCards.length) {
                    nextIndex = 0;
                } else if (updatedCards.length === this.activeCards.length) {
                    nextIndex = (nextIndex + 1) % newActiveCards.length;
                }

                this.currentCardIndex = nextIndex;
                this.userInput = '';
                this.showResult = false;

                // Start the next round
                this.startAnswering();
            }

            updateDisplay() {
                this.updateStats();
                this.updateVisibility();
                this.updateProgressDots();
                this.updateTimerDisplay();

                if (this.gameState === 'completed') {
                    return;
                }

                if (this.activeCards.length > 0) {
                    const currentCard = this.activeCards[this.currentCardIndex];
                    document.getElementById('card-front').textContent = currentCard.front;
                }

                if (this.gameState === 'reviewing' && this.showResult) {
                    this.updateResult();
                }
            }

            updateStats() {
                const percentCorrect = this.totalAttempts === 0 ? 0 : Math.round((this.correctAttempts / this.totalAttempts) * 100);
                const cardsMastered = this.allCards.filter(card => (this.cardProgress[card.id] || 0) >= 5).length;

                document.getElementById('percent-correct').textContent = percentCorrect;
                document.getElementById('cards-mastered').textContent = cardsMastered;
            }

            updateVisibility() {
                const elements = {
                    'waiting-state': this.gameState === 'waiting',
                    'card-display': this.gameState !== 'waiting' && this.gameState !== 'completed' && this.gameState !== 'loading',
                    'timer': this.gameState === 'answering',
                    'input-section': this.gameState === 'answering' && !this.showResult,
                    'result-section': this.gameState === 'reviewing' && this.showResult,
                    'progress-dots': this.gameState !== 'waiting' && this.gameState !== 'completed' && this.gameState !== 'loading',
                    'waiting-message': this.gameState === 'waiting',
                    'completion-screen': this.gameState === 'completed'
                };

                Object.entries(elements).forEach(([id, show]) => {
                    const element = document.getElementById(id);
                    if (show) {
                        element.classList.remove('hidden');
                    } else {
                        element.classList.add('hidden');
                    }
                });

                // Show loading message
                if (this.gameState === 'loading') {
                    const waitingCard = document.getElementById('waiting-state');
                    waitingCard.innerHTML = `
                        <div class="card-front">Loading flashcards...</div>
                        <div class="card-subtitle">Please wait</div>
                    `;
                    waitingCard.classList.remove('hidden');
                }
            }

            updateProgressDots() {
                const dotsContainer = document.getElementById('progress-dots');
                dotsContainer.innerHTML = '';

                this.activeCards.forEach((card, index) => {
                    const dot = document.createElement('div');
                    dot.className = 'progress-dot';
                    if (index === this.currentCardIndex) {
                        dot.classList.add('active');
                    }
                    dotsContainer.appendChild(dot);
                });
            }

            updateTimerDisplay() {
                const timerDisplay = document.getElementById('timer-display');
                const mins = Math.floor(this.timeLeft / 60);
                const secs = this.timeLeft % 60;
                timerDisplay.textContent = `${mins}:${secs.toString().padStart(2, '0')}`;

                if (this.timeLeft <= 5) {
                    timerDisplay.classList.add('timer-urgent');
                } else {
                    timerDisplay.classList.remove('timer-urgent');
                }
            }

            updateResult() {
                const resultBox = document.getElementById('result-box');
                const resultTitle = document.getElementById('result-title');
                const resultDetails = document.getElementById('result-details');

                if (this.lastAnswer.correct) {
                    resultBox.className = 'result-box result-correct';
                    resultTitle.textContent = 'âœ“ Correct!';
                    resultDetails.innerHTML = '';
                } else {
                    resultBox.className = 'result-box result-incorrect';
                    resultTitle.textContent = 'âœ— Incorrect';
                    resultDetails.innerHTML = `
                        <div>Your answer: <span class="result-answer">${this.lastAnswer.userAnswer}</span></div>
                        <div>Correct answer: <span class="result-answer">${this.lastAnswer.correctAnswer}</span></div>
                    `;
                }
            }
        }

        // Initialize the app when the page loads
        document.addEventListener('DOMContentLoaded', () => {
            new FlashcardApp();
        });
    </script>
</body>
</html>
